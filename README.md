# Swap Aggregator

Агрегатор для поиска оптимальных маршрутов обмена USDC на WETH в сети Polygon. Swap Aggregator анализирует несколько DEX пулов (Uniswap V2, Sushiswap, Quickswap) для поиска наилучших курсов обмена. Алгоритм разделяет общую сумму обмена на чанки и для каждого чанка находит пул с максимальным выходом WETH.

## Архитектура проекта

```
swap_aggregator/
├── src/
│   ├── main.rs         # Точка входа и демонстрация
│   ├── config.rs       # Константы и конфигурация
│   ├── provider.rs     # Взаимодействие с блокчейном
│   ├── math.rs         # Математические расчеты Uniswap V2
│   ├── pool.rs         # Структура Pool и методы работы с пулами
│   └── solver.rs       # Основная логика агрегации
├── Cargo.toml          # Зависимости проекта
├── .env.example        # Шаблон переменных окружения
├── .gitignore          # Исключения для Git
└── README.md           # Документация
```

### Модули проекта

#### `config.rs`
- Адреса токенов USDC, USDC.e и WETH в сети Polygon
- Параметры обмена (общая сумма, количество частей)
- Адреса Factory контрактов (Quickswap, Sushiswap)
- Функции конвертации между decimal и raw значениями

#### `math.rs`
- Реализация формулы Uniswap V2: `getAmountOut`
- Учет комиссии 0.3% для DEX обменов
- Unit-тесты для всех математических функций

#### `provider.rs`
- Создание провайдера для подключения к Polygon через Infura
- Автоматическое получение адресов пулов через Factory контракты
- Получение резервов из пулов ликвидности

#### `pool.rs`
- Структура `Pool` для представления пула ликвидности
- Метод `get_amount_out()` для расчета без обновления состояния
- Метод `mock_swap()` для симуляции обмена с обновлением резервов
- Обновление резервов из блокчейна

#### `solver.rs`
- Основной алгоритм поиска оптимальных маршрутов
- Сравнение пулов с использованием `get_amount_out`
- Применение реального swap к лучшему пулу
- Итерация по чанкам с выбором лучшего пула для каждого

## Установка и настройка

### Предварительные требования

- Rust 1.70+ ([установка](https://rustup.rs/))
- Аккаунт Infura ([регистрация](https://infura.io/))

### Клонирование и сборка

```bash
# Клонирование репозитория
git clone <repository-url>
cd swap_aggregator

# Сборка проекта
cargo build --release
```

### Настройка переменных окружения

1. Скопируйте файл с примером:
```bash
cp .env.example .env
```

2. Отредактируйте `.env` файл:
```bash
# Замените YOUR_PROJECT_ID на ваш реальный Project ID из Infura
INFURA_POLYGON_URL=https://polygon-mainnet.infura.io/v3/YOUR_PROJECT_ID
```

### Получение API ключа Infura

1. Зарегистрируйтесь на [infura.io](https://infura.io/)
2. Создайте новый проект
3. Выберите Polygon Mainnet
4. Скопируйте Project ID в переменную `INFURA_POLYGON_URL`

## Использование

### Запуск программы

```bash
cargo run
```
### Запуск тестов

```bash
# Запуск всех тестов
cargo test
```

## Технические детали

### Обработка множественных токенов USDC

Проект поддерживает два типа USDC в сети Polygon:
- **USDC** (`0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359`) - нативный USDC
- **USDC.e** (`0x2791bca1f2de4661ed88a30c99a7a9449aa84174`) - bridged USDC

Оба токена имеют одинаковые decimals (6) и обрабатываются одинаково.

### Обработка порядка токенов

В пулах Uniswap V2 токены упорядочены по адресам: `token0 < token1`. Проект автоматически определяет, какой резерв относится к USDC/USDC.e, а какой к WETH, сравнивая их адреса.


## Конфигурация

### Адреса токенов (Polygon Mainnet)

```rust
USDC_ADDRESS = "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359"    // Native USDC
USDC_E_ADDRESS = "0x2791bca1f2de4661ed88a30c99a7a9449aa84174"  // Bridged USDC.e
WETH_ADDRESS = "0x7ceB23fD6bC0adD59E62ac25578270cFf1b9f619"   // Wrapped ETH
```

### Параметры обмена

```rust
TOTAL_USDC_DECIMAL = 1_000_000.0                      // 1M USDC для обмена
NUM_CHUNKS = 100                                      // Количество частей
CHUNK_USDC_DECIMAL = TOTAL_USDC_DECIMAL / NUM_CHUNKS  // 10K USDC на часть
```

### Factory контракты

Проект использует Factory контракты для автоматического получения адресов пулов:

- **Quickswap V2**: `0x5757371414417b8C6CAad45bAeF941aBc7d3Ab32`
- **Sushiswap V2**: `0xc35DADB65012eC5796536bD9864eD8773aBc74C4`

### Приватность

- API ключи хранятся в переменных окружения
- .env файл исключен из Git репозитория
- Нет хранения приватных ключей или чувствительных данных
